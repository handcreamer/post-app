<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŒ¿åã¤ã¶ã‚„ãã‚¢ãƒ—ãƒª</title>
  <style>
    /* â˜… æ¬¡ã®ãƒ‘ãƒ¼ãƒˆ2ã§CSSã‚’å…¥ã‚Œã‚‹ */
    body {
  font-family: sans-serif;
  margin: 0;
  padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼ã¶ã‚“ä½™ç™½ */
  background: #f9f9f9;
}

textarea {
  font-size: 16px;
}

button {
  font-size: 16px;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background-color: #4CAF50;
  color: white;
}

button:hover {
  background-color: #45a049;
}

.post {
  background: white;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
}

.post-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.post-meta {
  font-size: 12px;
  color: #555;
}

.reply {
  margin-top: 10px;
  margin-left: 20px;
  background: #eee;
  border-radius: 4px;
  padding: 6px;
}

.like-btn {
  background-color: #ffd700;
  color: black;
  padding: 2px 6px;
  border-radius: 12px;
  font-size: 14px;
  margin-top: 6px;
}

.delete-btn {
  background-color: #d9534f;
  margin-left: 10px;
}

.reaction-summary {
  font-weight: bold;
  margin-bottom: 10px;
}

.reaction-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.badge {
  background: red;
  color: white;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 999px;
  margin-left: 5px;
}

/* ãƒŠãƒ“ãƒœã‚¿ãƒ³ç‰¹åŒ– */
#nav button {
  background-color: transparent;
  border: none;
  color: #333;
  font-size: 18px;
  flex: 1;
}

#nav button.active {
  color: #4CAF50;
  font-weight: bold;
}

@media (max-width: 768px) {
  textarea {
    font-size: 18px;
  }

  button {
    font-size: 18px;
  }

  #nav button {
    font-size: 20px;
  }
}

  </style>
</head>
<body>

  <!-- ğŸµ BGM ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <audio id="bgm" loop>
    <source src="äººç‹¼ã®ç‚ºã®å­å®ˆå”„.mp3" type="audio/mp3" />
    ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
  </audio>
  <div style="padding: 5px;">
    ğŸ”Š BGM:
    <button onclick="toggleBgm()">â–¶ / â¸</button>
    <input type="range" min="0" max="1" step="0.01" value="0.5" onchange="setVolume(this.value)">
  </div>

  <!-- ğŸ“ æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="postForm" style="padding: 10px;">
    <textarea id="inputText" placeholder="ã¤ã¶ã‚„ã„ã¦ã¿ã‚ˆã†ï¼" rows="3" style="width: 100%;"></textarea>
    <select id="replySetting" style="width: 100%; margin-top: 5px;">
      <option value="true">è¿”ä¿¡ã‚’å—ã‘ä»˜ã‘ã‚‹</option>
      <option value="false">è¿”ä¿¡ã‚’å—ã‘ä»˜ã‘ãªã„</option>
    </select>
    <button onclick="submitPost()" style="margin-top: 5px; width: 100%;">æŠ•ç¨¿</button>
  </div>

  <!-- ğŸ—¨ï¸ è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="viewContainer" style="padding: 10px;"></div>

  <!-- â­ è‡ªåˆ†ãŒã„ã„ã­ã—ãŸæŠ•ç¨¿ä¸€è¦§ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³â†’ãƒœã‚¿ãƒ³ã§é·ç§»ï¼‰ -->
  <div id="likedPostsContainer" style="display:none; padding:10px;">
    <h3>â­ è‡ªåˆ†ãŒã„ã„ã­ã—ãŸæŠ•ç¨¿</h3>
    <div id="likedPostsList"></div>
    <button onclick="backToReactions()">â† ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸æˆ»ã‚‹</button>
  </div>

  <!-- ğŸ”» ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div id="nav" style="position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; background: #eee; padding: 10px 0;">
    <button onclick="switchView('all')">ğŸ—¨ï¸ ã¤ã¶ã‚„ã</button>
    <button onclick="switchView('mine')">ğŸŒŸ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</button>
    <button onclick="switchView('messages')" id="messageTab">ğŸ’Œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
  </div>

  <script>
    // â˜… ãƒ‘ãƒ¼ãƒˆ3ãƒ»4ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…¥ã‚Œã‚‹
    // è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¿å­˜ï¼†èª­ã¿è¾¼ã¿ï¼‰
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

// æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
let allPosts = [];
try {
  allPosts = JSON.parse(localStorage.getItem("allPosts")) || [];
} catch {
  allPosts = [];
}

// è‡ªåˆ†ãŒâ­ã—ãŸæŠ•ç¨¿IDãƒªã‚¹ãƒˆ
let likedPostIds = JSON.parse(localStorage.getItem("likedPostIds") || "[]");

// æœªèª­è¿”ä¿¡ãƒ»æœªèª­ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
let replyNotice = JSON.parse(localStorage.getItem("replyNotice") || "{}");
let likeNotice = JSON.parse(localStorage.getItem("likeNotice") || "{}");

// éŸ³é‡è¨­å®š
const bgm = document.getElementById("bgm");
bgm.volume = 0.5;
function toggleBgm() {
  if (bgm.paused) {
    bgm.play();
  } else {
    bgm.pause();
  }
}
function setVolume(value) {
  bgm.volume = parseFloat(value);
}

// æŠ•ç¨¿ã™ã‚‹
function submitPost() {
  const input = document.getElementById("inputText");
  const replyOption = document.getElementById("replySetting");
  const text = input.value.trim();
  if (text === "") return;

  const post = {
    id: Date.now().toString(),
    text,
    time: new Date().toLocaleString(),
    userId,
    canReply: replyOption.value === "true",
    replies: [],
    likes: 0,
    likesBy: []
  };

  allPosts.unshift(post);
  savePosts();
  input.value = "";
  switchView(currentView); // å†æç”»
}

// æŠ•ç¨¿ä¿å­˜
function savePosts() {
  localStorage.setItem("allPosts", JSON.stringify(allPosts));
}
let currentView = "all";

// ãƒ¡ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function switchView(view) {
  currentView = view;

  document.getElementById("viewContainer").style.display = "block";
  document.getElementById("likedPostsContainer").style.display = "none";

  const viewDiv = document.getElementById("viewContainer");
  viewDiv.innerHTML = "";

  // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã®é¸æŠè¡¨ç¤º
  document.querySelectorAll("#nav button").forEach(btn => btn.classList.remove("active"));
  if (view === "all") {
    renderPosts(allPosts.filter(p => p.userId !== userId), viewDiv);
    document.querySelector("#nav button:nth-child(1)").classList.add("active");
  } else if (view === "mine") {
    const myPosts = allPosts.filter(p => p.userId === userId);
    let totalLikes = myPosts.reduce((sum, p) => sum + p.likes, 0);

    const topBar = document.createElement("div");
    topBar.className = "reaction-topbar";
    topBar.innerHTML = `<div class="reaction-summary">ã“ã‚Œã¾ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šâ­${totalLikes}</div>
      <button onclick="showLikedPosts()">ğŸ’«å—ä¿¡å±¥æ­´</button>`;
    viewDiv.appendChild(topBar);

    renderPosts(myPosts, viewDiv);
    document.querySelector("#nav button:nth-child(2)").classList.add("active");
  } else if (view === "messages") {
    const repliedToMe = allPosts.filter(p => p.userId === userId && p.replies.length > 0);
    renderMessages(repliedToMe, viewDiv);
    document.querySelector("#nav button:nth-child(3)").classList.add("active");

    // æœªèª­ãƒ•ãƒ©ã‚°ã‚’æ¶ˆã™
    document.getElementById("messageTab").innerHTML = "ğŸ’Œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸";
    localStorage.setItem("replyNotice", "{}");
  }
}

// æŠ•ç¨¿ä¸€è¦§è¡¨ç¤º
function renderPosts(posts, container) {
  container.innerHTML = "";

  posts.forEach(post => {
    const postEl = document.createElement("div");
    postEl.className = "post";

    const header = document.createElement("div");
    header.className = "post-header";
    header.innerHTML = `
      <div><strong>${post.text}</strong></div>
      <div class="post-meta">${post.time}</div>
    `;
    postEl.appendChild(header);

    const likeBtn = document.createElement("button");
    likeBtn.className = "like-btn";
    likeBtn.textContent = `â­ ${post.likes}`;
    if (post.likesBy.includes(userId)) {
      likeBtn.disabled = true;
      likeBtn.style.opacity = 0.6;
    }
    likeBtn.onclick = (e) => {
      e.stopPropagation();
      if (post.likesBy.includes(userId)) return;
      post.likes++;
      post.likesBy.push(userId);
      likedPostIds.push(post.id);
      likeNotice[post.id] = true;
      localStorage.setItem("likedPostIds", JSON.stringify(likedPostIds));
      localStorage.setItem("likeNotice", JSON.stringify(likeNotice));
      savePosts();
      switchView(currentView);
    };
    postEl.appendChild(likeBtn);

    if (post.userId === userId) {
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "ğŸ—‘ï¸";
      delBtn.onclick = () => {
        if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          allPosts = allPosts.filter(p => p.id !== post.id);
          savePosts();
          switchView(currentView);
        }
      };
      postEl.appendChild(delBtn);
    }

    if (post.canReply) {
      postEl.onclick = () => openReplyArea(post, postEl);
    }

    // è¿”ä¿¡è¡¨ç¤º
    if (post.replies.length > 0) {
      const repliesEl = document.createElement("div");
      post.replies.forEach(reply => {
        const replyEl = document.createElement("div");
        replyEl.className = "reply";
        replyEl.innerHTML = `<div>${reply.text}</div><small>${reply.time}</small>`;
        repliesEl.appendChild(replyEl);
      });
      postEl.appendChild(repliesEl);
    }

    container.appendChild(postEl);
  });
}

// è¿”ä¿¡æ¬„è¡¨ç¤º
function openReplyArea(post, parentEl) {
  const input = document.createElement("textarea");
  input.placeholder = "è¿”ä¿¡ã‚’å…¥åŠ›...";
  input.style.marginTop = "10px";

  const btn = document.createElement("button");
  btn.textContent = "è¿”ä¿¡";
  btn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;
    post.replies.push({
      text,
      time: new Date().toLocaleString(),
      from: userId
    });

    replyNotice[post.id] = true;
    localStorage.setItem("replyNotice", JSON.stringify(replyNotice));
    savePosts();
    switchView(currentView);
  };

  parentEl.appendChild(input);
  parentEl.appendChild(btn);
}

// è‡ªåˆ†ãŒã„ã„ã­ã—ãŸæŠ•ç¨¿ã‚’è¦‹ã‚‹
function showLikedPosts() {
  document.getElementById("viewContainer").style.display = "none";
  document.getElementById("likedPostsContainer").style.display = "block";

  const likedList = document.getElementById("likedPostsList");
  likedList.innerHTML = "";

  const posts = allPosts.filter(p => likedPostIds.includes(p.id));
  renderPosts(posts, likedList);
}

// æˆ»ã‚‹ãƒœã‚¿ãƒ³
function backToReactions() {
  document.getElementById("likedPostsContainer").style.display = "none";
  switchView("mine");
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»é¢è¡¨ç¤º
function renderMessages(posts, container) {
  container.innerHTML = "";
  posts.forEach(post => {
    const postEl = document.createElement("div");
    postEl.className = "post";
    postEl.innerHTML = `<strong>${post.text}</strong><br><small>${post.time}</small>`;
    post.replies.forEach(reply => {
      const replyEl = document.createElement("div");
      replyEl.className = "reply";
      replyEl.innerHTML = `<div>${reply.text}</div><small>${reply.time}</small>`;
      postEl.appendChild(replyEl);
    });
    container.appendChild(postEl);
  });
}

// åˆæœŸè¡¨ç¤º
switchView("all");

// ğŸ”´ æœªèª­é€šçŸ¥ãƒãƒƒã‚¸
const myReplyPosts = allPosts.filter(p => p.userId === userId && p.replies.length > 0);
let unreadCount = 0;
myReplyPosts.forEach(p => {
  if (replyNotice[p.id]) unreadCount++;
});
if (unreadCount > 0) {
  document.getElementById("messageTab").innerHTML = "ğŸ’Œ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸ”´";
}

  </script>

</body>
</html>
