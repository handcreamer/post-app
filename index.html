<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•ç¨¿ã‚¢ãƒ—ãƒªï¼ˆBGMä»˜ãï¼‹éŸ³é‡èª¿æ•´ï¼‹åœæ­¢ãƒœã‚¿ãƒ³ï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea, select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .post-btn {
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 5px;
    }
    .post-btn:hover {
      background-color: #45a049;
    }

    .container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    .column {
      width: 33%;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
    }
    .post {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
    }
    .reply {
      background: #f0f0f0;
      margin-top: 6px;
      padding: 6px;
      border-radius: 6px;
      font-size: 14px;
    }
    .disabled {
      opacity: 0.5;
      cursor: default;
    }
    .like-btn {
      margin-top: 6px;
      display: inline-block;
      background-color: #ffd700;
      color: black;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
    }

    .bgm-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .column {
        width: 100%;
      }
      textarea, select {
        font-size: 18px;
      }
      .like-btn {
        font-size: 16px;
      }
      .post-btn {
        width: 100%;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

  <h1>æŠ•ç¨¿ã‚¢ãƒ—ãƒªï¼ˆBGMä»˜ãï¼‰</h1>

  <!-- âœ… BGM å†ç”Ÿï¼†éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="bgm-controls">
    <button id="toggleBgm">å†ç”ŸğŸµ</button>
    <label for="volume">éŸ³é‡</label>
    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
  </div>
  <audio id="bgm" src="äººç‹¼ã®ç‚ºã®å­å®ˆå”„.mp3" loop></audio>

  <textarea id="inputText" placeholder="ã¤ã¶ã‚„ã„ã¦ã¿ã‚ˆã†ï¼"></textarea><br>
  <select id="replySetting">
    <option value="true">è¿”ä¿¡ã‚’å—ã‘ä»˜ã‘ã‚‹</option>
    <option value="false">è¿”ä¿¡ã‚’å—ã‘ä»˜ã‘ãªã„</option>
  </select><br>
  <button class="post-btn" onclick="submitPost()">æŠ•ç¨¿</button>

  <div class="container">
    <div class="column">
      <h3>ğŸŒ ã¿ã‚“ãªã®ã¤ã¶ã‚„ã</h3>
      <div id="allPosts"></div>
    </div>
    <div class="column">
      <h3>ğŸ§‘â€ğŸ’¬ è‡ªåˆ†ã®ã¤ã¶ã‚„ã</h3>
      <div id="myPosts"></div>
    </div>
    <div class="column">
      <h3>ğŸ’¬ è¿”ä¿¡æ¬„</h3>
      <div id="replyArea">æŠ•ç¨¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¿”ä¿¡ã—ã‚ˆã†ï¼</div>
    </div>
  </div>

  <script>
    const bgm = document.getElementById("bgm");
    const toggleBtn = document.getElementById("toggleBgm");
    const volumeSlider = document.getElementById("volume");

    let isPlaying = false;

    toggleBtn.addEventListener("click", () => {
      if (isPlaying) {
        bgm.pause();
        toggleBtn.textContent = "å†ç”ŸğŸµ";
      } else {
        bgm.play();
        toggleBtn.textContent = "åœæ­¢â¸ï¸";
      }
      isPlaying = !isPlaying;
    });

    volumeSlider.addEventListener("input", () => {
      bgm.volume = volumeSlider.value;
    });

    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem("userId", userId);
    }

    let allPosts = [];
    try {
      allPosts = JSON.parse(localStorage.getItem("allPosts")) || [];
    } catch (e) {
      allPosts = [];
    }

    let selectedPost = null;

    function savePosts() {
      localStorage.setItem("allPosts", JSON.stringify(allPosts));
    }

    function submitPost() {
      const input = document.getElementById("inputText");
      const replyOption = document.getElementById("replySetting");
      const text = input.value.trim();
      if (text === "") return;

      const post = {
        id: Date.now().toString(),
        text: text,
        time: new Date().toLocaleString(),
        userId: userId,
        canReply: replyOption.value === "true",
        replies: [],
        likes: 0
      };

      allPosts.unshift(post);
      input.value = "";
      savePosts();
      renderPosts();
    }

    function renderPosts() {
      const allDiv = document.getElementById("allPosts");
      const myDiv = document.getElementById("myPosts");
      allDiv.innerHTML = "";
      myDiv.innerHTML = "";

      let likedPosts = [];
      try {
        likedPosts = JSON.parse(localStorage.getItem("likedPosts") || "[]");
      } catch (e) {
        likedPosts = [];
      }

      allPosts.forEach(post => {
        const postEl = document.createElement("div");
        postEl.className = "post";
        postEl.innerHTML = `
          <strong>${post.text}</strong><br>
          <small>${post.time}</small><br>
          <em>${post.canReply ? "âœ‰ï¸ è¿”ä¿¡å¯" : "ğŸ”’ è¿”ä¿¡ä¸å¯"}</em><br>
        `;

        const likeBtn = document.createElement("button");
        likeBtn.className = "like-btn";
        likeBtn.textContent = `â­ ${post.likes}`;

        const alreadyLiked = likedPosts.includes(post.id);

        if (alreadyLiked) {
          likeBtn.disabled = true;
          likeBtn.style.opacity = 0.6;
          likeBtn.style.cursor = "not-allowed";
          likeBtn.title = "1å›ã—ã‹æŠ¼ã›ã¾ã›ã‚“";
        }

        likeBtn.onclick = (e) => {
          e.stopPropagation();
          if (alreadyLiked) return;
          post.likes++;
          likedPosts.push(post.id);
          localStorage.setItem("likedPosts", JSON.stringify(likedPosts));
          savePosts();
          renderPosts();
        };

        postEl.appendChild(likeBtn);

        if (post.canReply) {
          postEl.onclick = () => openReplyArea(post);
        } else {
          postEl.classList.add("disabled");
          postEl.onclick = () => alert("ã“ã®æŠ•ç¨¿ã¯è¿”ä¿¡ã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã›ã‚“ã€‚");
        }

        if (post.userId === userId) {
          myDiv.appendChild(postEl);
        } else {
          allDiv.appendChild(postEl);
        }
      });
    }

    function openReplyArea(post) {
      selectedPost = post;
      const area = document.getElementById("replyArea");
      area.innerHTML = "";

      const header = document.createElement("div");
      header.innerHTML = `<strong>${post.text}</strong><br><small>${post.time}</small>`;
      area.appendChild(header);

      if (!post.canReply) {
        const msg = document.createElement("p");
        msg.textContent = "ã“ã®æŠ•ç¨¿ã¯è¿”ä¿¡ã§ãã¾ã›ã‚“ã€‚";
        area.appendChild(msg);
        return;
      }

      const input = document.createElement("textarea");
      input.placeholder = "è¿”ä¿¡ã‚’å…¥åŠ›...";
      input.style.marginTop = "10px";

      const btn = document.createElement("button");
      btn.textContent = "è¿”ä¿¡";
      btn.onclick = () => {
        const replyText = input.value.trim();
        if (replyText) {
          post.replies.push({
            text: replyText,
            time: new Date().toLocaleString()
          });
          input.value = "";
          savePosts();
          openReplyArea(post);
        }
      };

      area.appendChild(input);
      area.appendChild(btn);

      if (post.replies.length > 0) {
        post.replies.forEach(reply => {
          const replyDiv = document.createElement("div");
          replyDiv.className = "reply";
          replyDiv.innerHTML = `<div>${reply.text}</div><small>${reply.time}</small>`;
          area.appendChild(replyDiv);
        });
      }
    }

    renderPosts();
  </script>

</body>
</html>
